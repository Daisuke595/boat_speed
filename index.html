<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<script>
let intervalId = null; // タイマーIDを格納する変数
let lastPosition = null; // 前回の位置情報を保存する変数
let lastSpeed = null;

function calculateBearing(lat1, lon1, lat2, lon2) {
    const φ1 = lat1 * Math.PI / 180;
    const φ2 = lat2 * Math.PI / 180;
    const Δλ = (lon2 - lon1) * Math.PI / 180;

    const y = Math.sin(Δλ) * Math.cos(φ2);
    const x = Math.cos(φ1) * Math.sin(φ2) -
              Math.sin(φ1) * Math.cos(φ2) * Math.cos(Δλ);
    const θ = Math.atan2(y, x);
    const bearing = (θ * 180 / Math.PI + 360) % 360;

    return bearing;
}


// 2点間の距離をメートル単位で計算する関数（ハバーサイン公式）
function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371000; // 地球の半径（メートル）
    const φ1 = lat1 * Math.PI / 180;
    const φ2 = lat2 * Math.PI / 180;
    const Δφ = (lat2 - lat1) * Math.PI / 180;
    const Δλ = (lon2 - lon1) * Math.PI / 180;

    const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
              Math.cos(φ1) * Math.cos(φ2) *
              Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    const distance = R * c;
    
    return distance; // メートル単位での距離
}

// 位置情報を取得する関数
function getLocation() {
    navigator.geolocation.getCurrentPosition(displayLocation);
}

// 位置情報を表示する関数
function displayLocation(position) {

    // 各データを個別にコンソールに出力
    console.log("緯度:", position.coords.latitude);
    console.log("経度:", position.coords.longitude);
    //console.log("高度:", position.coords.altitude);
    //console.log("位置精度:", position.coords.accuracy);
    //console.log("高度精度:", position.coords.altitudeAccuracy);
    //console.log("移動方向:", position.coords.heading);
    //console.log("速度:", position.coords.speed);

    // 現在時刻を取得
    const currentTimestamp = Date.now(); // 現在のタイムスタンプを取得
    const currentDate = new Date(currentTimestamp);
    // Safari互換性のためにスラッシュ区切り形式に変換
    const dateStr = currentDate.toISOString().slice(0, 19).replace("T", " ");
    const fixedDateStr = dateStr.replace(/-/g, '/');
    // 日本語ロケールでフォーマット
    // 日本標準時（JST）でフォーマット
    const formattedDate = currentDate.toLocaleString('ja-JP', {
        timeZone: 'Asia/Tokyo', // タイムゾーンを明確に指定
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
    console.log("取得時刻:", formattedDate);

    // 計算した速度の情報
    let calculatedSpeed = "未計算（初回取得）";
    let distanceTraveled = "未計算";
    let timeDiff = "未計算";
    let speedChange = "初回取得";
    let speedDifference = 0;
    let bearing = "未計算";
    
    // 前回の位置情報がある場合は距離と速度を計算
    if (lastPosition) {
        // 2点間の距離をメートル単位で計算
        const distance = calculateDistance(
            lastPosition.coords.latitude, 
            lastPosition.coords.longitude,
            position.coords.latitude, 
            position.coords.longitude
        );
        
        // 時間差（秒）を計算
        const timeElapsed = (currentTimestamp - lastPosition.timestamp) / 1000;
        
        // 速度（m/s）を計算
        const speed = distance / timeElapsed;
        
        // km/hに変換
        const speedKmh = speed * 3.6;
        
        // 計算結果を文字列に格納
        distanceTraveled = `${distance.toFixed(2)} m`;
        timeDiff = `${timeElapsed.toFixed(2)} 秒`;
        calculatedSpeed = `${speed.toFixed(2)} m/s (${speedKmh.toFixed(2)} km/h)`;

        if (lastSpeed !== null) {
            speedChange = speed > lastSpeed ? "UP" : "DOWN";
            speedDifference = Math.abs(speed - lastSpeed);
        }

        console.log("速度変化:", speedChange);
        console.log("速度差分:", speedDifference.toFixed(2), "m/s");

        lastSpeed = speed;

        if (lastPosition) {
            bearing = calculateBearing(
                lastPosition.coords.latitude,
                lastPosition.coords.longitude,
                position.coords.latitude,
                position.coords.longitude
            );
        console.log("移動方位:", bearing.toFixed(2), "度");
}

    }

    // 位置情報を取得して文字列を生成
    const geo_text = `
        緯度: ${position.coords.latitude.toFixed(2)}, 
        経度: ${position.coords.longitude.toFixed(2)}, 
        位置精度: ${position.coords.accuracy.toFixed(2)}, 
        時刻: ${formattedDate}
        距離: ${distanceTraveled},
        経過時間: ${timeDiff},
        速度: ${calculatedSpeed},
        速度変化: ${speedChange},
        速度差分: ${speedDifference.toFixed(2)} m/s,
        移動方位: ${bearing !== "未計算" ? bearing.toFixed(2) + "度" : bearing}
    `;

    // ページ上に表示
    const dataList = document.getElementById("dataList");
    const listItem = document.createElement("li");
    listItem.textContent = geo_text;
    dataList.appendChild(listItem); 
    // 今回の位置情報を保存（タイムスタンプも含める）
    lastPosition = {
        coords: {
            latitude: position.coords.latitude,
            longitude: position.coords.longitude
        },
        timestamp: currentTimestamp
    };
}

// 設定時刻ごとに位置情報を取得する関数
function startTracking() {
    // 既存のタイマーがあればクリア
    if (intervalId !== null) {
        clearInterval(intervalId);
        intervalId = null;
    }

    // 選択された間隔を取得
    const interval = document.querySelector('input[name="interval"]:checked').value;

    // 指定された間隔（ミリ秒）ごとに位置情報を取得
    intervalId = setInterval(getLocation, parseInt(interval));
}

// トラッキングを停止する関数
function stopTracking() {
    if (intervalId !== null) {
        clearInterval(intervalId);
        intervalId = null;
        lastPosition = null; // 前回の位置情報をリセット
        alert("位置情報の取得を停止しました。");
    }
}

function formatDateForSafari(positionTimestamp) {
    // タイムスタンプを文字列形式の日付に変換
    const dateStr = new Date(positionTimestamp).toISOString().slice(0, 19).replace("T", " ");
    // Safari互換性のためにハイフンをスラッシュに変換
    const fixedDateStr = dateStr.replace(/-/g, '/');
    // 日本語ロケールで日時をフォーマット
    const formattedDate = new Date(fixedDateStr).toLocaleString('ja-JP');
    return formattedDate;
}

</script>
</head>
<body>

<h1>位置情報取得プログラム</h1>

<!-- ラジオボタンで間隔を選択 -->
<p>位置情報の取得間隔を選択してください:</p>
<label><input type="radio" name="interval" value="10000" checked> 10秒</label><br>
<label><input type="radio" name="interval" value="15000"> 15秒</label><br>
<label><input type="radio" name="interval" value="20000"> 20秒</label><br>

<!-- ボタンで開始・停止 -->
<button onclick="startTracking()">開始</button>
<button onclick="stopTracking()">停止</button>

<!-- データ表示エリア -->
<h2>取得した位置情報:</h2>
<ul id="dataList"></ul>

</body>
</html>
